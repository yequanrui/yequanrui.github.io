<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3-14 构建离线应用 | 深入浅出Webpack</title>
    <meta name="description" content="webpack使用学习(吴浩麟版)">
    <link rel="icon" href="/webpackLearn/favicon.ico">
  <link rel="manifest" href="/webpackLearn/manifest.json">
    
    <link rel="preload" href="/webpackLearn/assets/css/styles.77d280ee.css" as="style"><link rel="preload" href="/webpackLearn/assets/js/app.77d280ee.js" as="script"><link rel="preload" href="/webpackLearn/assets/js/4.7fbde3f9.js" as="script"><link rel="prefetch" href="/webpackLearn/assets/js/1.f37f7214.js"><link rel="prefetch" href="/webpackLearn/assets/js/10.15a163ee.js"><link rel="prefetch" href="/webpackLearn/assets/js/11.d8cde28c.js"><link rel="prefetch" href="/webpackLearn/assets/js/12.6e485d95.js"><link rel="prefetch" href="/webpackLearn/assets/js/13.8167464c.js"><link rel="prefetch" href="/webpackLearn/assets/js/14.7e75c412.js"><link rel="prefetch" href="/webpackLearn/assets/js/15.593f55f2.js"><link rel="prefetch" href="/webpackLearn/assets/js/16.31248cfb.js"><link rel="prefetch" href="/webpackLearn/assets/js/17.c428f9be.js"><link rel="prefetch" href="/webpackLearn/assets/js/18.1a442e25.js"><link rel="prefetch" href="/webpackLearn/assets/js/19.d2aaef13.js"><link rel="prefetch" href="/webpackLearn/assets/js/2.d7cdf3d2.js"><link rel="prefetch" href="/webpackLearn/assets/js/20.d7645fb0.js"><link rel="prefetch" href="/webpackLearn/assets/js/21.d80e0286.js"><link rel="prefetch" href="/webpackLearn/assets/js/22.b41f3cbc.js"><link rel="prefetch" href="/webpackLearn/assets/js/23.f8779f82.js"><link rel="prefetch" href="/webpackLearn/assets/js/24.958d3c85.js"><link rel="prefetch" href="/webpackLearn/assets/js/25.2e076f51.js"><link rel="prefetch" href="/webpackLearn/assets/js/26.eff2c3e5.js"><link rel="prefetch" href="/webpackLearn/assets/js/27.40064e0e.js"><link rel="prefetch" href="/webpackLearn/assets/js/28.9ad06b95.js"><link rel="prefetch" href="/webpackLearn/assets/js/29.3a0865a0.js"><link rel="prefetch" href="/webpackLearn/assets/js/3.128b6292.js"><link rel="prefetch" href="/webpackLearn/assets/js/30.25c4f77e.js"><link rel="prefetch" href="/webpackLearn/assets/js/31.80207808.js"><link rel="prefetch" href="/webpackLearn/assets/js/32.20b8aa68.js"><link rel="prefetch" href="/webpackLearn/assets/js/33.414db07e.js"><link rel="prefetch" href="/webpackLearn/assets/js/34.3c015b40.js"><link rel="prefetch" href="/webpackLearn/assets/js/35.cfff3ee7.js"><link rel="prefetch" href="/webpackLearn/assets/js/36.5693324e.js"><link rel="prefetch" href="/webpackLearn/assets/js/37.11302d4c.js"><link rel="prefetch" href="/webpackLearn/assets/js/38.5f09cd6d.js"><link rel="prefetch" href="/webpackLearn/assets/js/39.b8a318d2.js"><link rel="prefetch" href="/webpackLearn/assets/js/40.010eca0d.js"><link rel="prefetch" href="/webpackLearn/assets/js/41.ed550296.js"><link rel="prefetch" href="/webpackLearn/assets/js/42.bf111eba.js"><link rel="prefetch" href="/webpackLearn/assets/js/43.4178a489.js"><link rel="prefetch" href="/webpackLearn/assets/js/44.f9b7d3d8.js"><link rel="prefetch" href="/webpackLearn/assets/js/45.4aa3e07a.js"><link rel="prefetch" href="/webpackLearn/assets/js/46.766fddaf.js"><link rel="prefetch" href="/webpackLearn/assets/js/47.7a16de60.js"><link rel="prefetch" href="/webpackLearn/assets/js/48.ec0b2eb5.js"><link rel="prefetch" href="/webpackLearn/assets/js/49.9ba3c919.js"><link rel="prefetch" href="/webpackLearn/assets/js/5.7aab97c6.js"><link rel="prefetch" href="/webpackLearn/assets/js/50.fe7bdfef.js"><link rel="prefetch" href="/webpackLearn/assets/js/51.b5d4459d.js"><link rel="prefetch" href="/webpackLearn/assets/js/52.aa5814ff.js"><link rel="prefetch" href="/webpackLearn/assets/js/53.8ad00778.js"><link rel="prefetch" href="/webpackLearn/assets/js/54.92f9cbd1.js"><link rel="prefetch" href="/webpackLearn/assets/js/55.d04ea61a.js"><link rel="prefetch" href="/webpackLearn/assets/js/56.4b17dc92.js"><link rel="prefetch" href="/webpackLearn/assets/js/57.82800a68.js"><link rel="prefetch" href="/webpackLearn/assets/js/58.b4482327.js"><link rel="prefetch" href="/webpackLearn/assets/js/59.40bf3560.js"><link rel="prefetch" href="/webpackLearn/assets/js/6.e891bd55.js"><link rel="prefetch" href="/webpackLearn/assets/js/60.3a147a38.js"><link rel="prefetch" href="/webpackLearn/assets/js/61.9fab59f3.js"><link rel="prefetch" href="/webpackLearn/assets/js/62.7aacd083.js"><link rel="prefetch" href="/webpackLearn/assets/js/63.7e09e4d8.js"><link rel="prefetch" href="/webpackLearn/assets/js/64.b3113e47.js"><link rel="prefetch" href="/webpackLearn/assets/js/65.d1030852.js"><link rel="prefetch" href="/webpackLearn/assets/js/66.799e920a.js"><link rel="prefetch" href="/webpackLearn/assets/js/67.a898b698.js"><link rel="prefetch" href="/webpackLearn/assets/js/68.92cd43e9.js"><link rel="prefetch" href="/webpackLearn/assets/js/69.262008ea.js"><link rel="prefetch" href="/webpackLearn/assets/js/7.22611dc1.js"><link rel="prefetch" href="/webpackLearn/assets/js/70.afff8df7.js"><link rel="prefetch" href="/webpackLearn/assets/js/71.7818a2c2.js"><link rel="prefetch" href="/webpackLearn/assets/js/8.5b18428a.js"><link rel="prefetch" href="/webpackLearn/assets/js/9.9ef066a0.js">
    <link rel="stylesheet" href="/webpackLearn/assets/css/styles.77d280ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/webpackLearn/" class="home-link router-link-active"><!----><span class="site-name">
      深入浅出Webpack
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/webpackLearn/" class="nav-link">首页</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webpackLearn/" class="nav-link">首页</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>入门</span><!----></p><ul class="sidebar-group-items"><li><a href="/webpackLearn/intro.html" class="sidebar-link">前言</a></li><li><a href="/webpackLearn/intro/intro-1.html" class="sidebar-link">前端的发展</a></li><li><a href="/webpackLearn/intro/intro-2.html" class="sidebar-link">前端常用构建工具</a></li><li><a href="/webpackLearn/intro/intro-3.html" class="sidebar-link">webpack安装使用</a></li><li><a href="/webpackLearn/intro/intro-4.html" class="sidebar-link">使用Loader</a></li><li><a href="/webpackLearn/intro/intro-5.html" class="sidebar-link">使用Plugin</a></li><li><a href="/webpackLearn/intro/intro-6.html" class="sidebar-link">使用DevServer</a></li><li><a href="/webpackLearn/intro/intro-7.html" class="sidebar-link">核心概念</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>配置</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>实战</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/webpackLearn/practice/practice-1.html" class="sidebar-link">使用ES6</a></li><li><a href="/webpackLearn/practice/practice-2.html" class="sidebar-link">使用TypeScript</a></li><li><a href="/webpackLearn/practice/practice-3.html" class="sidebar-link">使用Flow</a></li><li><a href="/webpackLearn/practice/practice-4.html" class="sidebar-link">使用SCSS</a></li><li><a href="/webpackLearn/practice/practice-5.html" class="sidebar-link">使用PostCSS</a></li><li><a href="/webpackLearn/practice/practice-6.html" class="sidebar-link">使用React</a></li><li><a href="/webpackLearn/practice/practice-7.html" class="sidebar-link">使用Vue</a></li><li><a href="/webpackLearn/practice/practice-8.html" class="sidebar-link">使用Angular2</a></li><li><a href="/webpackLearn/practice/practice-9.html" class="sidebar-link">为单页应用生成HTML</a></li><li><a href="/webpackLearn/practice/practice-10.html" class="sidebar-link">管理多个单页应用</a></li><li><a href="/webpackLearn/practice/practice-11.html" class="sidebar-link">构建同构应用</a></li><li><a href="/webpackLearn/practice/practice-12.html" class="sidebar-link">构建Electron应用</a></li><li><a href="/webpackLearn/practice/practice-13.html" class="sidebar-link">构建Npm模块</a></li><li><a href="/webpackLearn/practice/practice-14.html" class="active sidebar-link">构建离线应用</a></li><li><a href="/webpackLearn/practice/practice-15.html" class="sidebar-link">搭配Npm Script</a></li><li><a href="/webpackLearn/practice/practice-16.html" class="sidebar-link">代码检查</a></li><li><a href="/webpackLearn/practice/practice-17.html" class="sidebar-link">通过Node.js API启动Webpack</a></li><li><a href="/webpackLearn/practice/practice-18.html" class="sidebar-link">使用Webpack Dev Middleware</a></li><li><a href="/webpackLearn/practice/practice-19.html" class="sidebar-link">加载图片</a></li><li><a href="/webpackLearn/practice/practice-20.html" class="sidebar-link">加载Svg</a></li><li><a href="/webpackLearn/practice/practice-19.html" class="sidebar-link">加载SourceMap</a></li><li><a href="/webpackLearn/practice/practice-20.html" class="sidebar-link">实战总结</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>优化</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>原理</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>附录</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="_3-14-构建离线应用"><a href="#_3-14-构建离线应用" aria-hidden="true" class="header-anchor">#</a> 3-14 构建离线应用</h1><h2 id="认识离线应用"><a href="#认识离线应用" aria-hidden="true" class="header-anchor">#</a> 认识离线应用</h2><p>你的网页性能优化的再好，如果网络不好那也会导致网页的体验差。 离线应用是指通过离线缓存技术，让资源在第一次被加载后缓存在本地，下次访问它时就直接返回本地的文件，就算没有网络连接。</p><p>离线应用有以下优点：</p><ul><li>在没有网络的情况下也能打开网页。</li><li>由于部分被缓存的资源直接从本地加载，对用户来说可以加速网页加载速度，对网站运营者来说可以减少服务器压力以及传输流量费用。
离线应用的核心是离线缓存技术，历史上曾先后出现 2 种离线离线缓存技术，它们分别是：</li></ul><ol><li><strong>AppCache</strong> 又叫 Application Cache，目前已经从 Web 标准中删除，请尽量不要使用它。</li><li><strong>Service Workers</strong> 是目前最新的离线缓存技术，是 Web Worker 的一部分。 它通过拦截网络请求实现离线缓存，比 AppCache 更加灵活。它也是构建 PWA 应用的关键技术之一。</li></ol><p>Service Workers 相比于 AppCache 来说更加灵活，因为它可以通过 JavaScript 代码去控制缓存的逻辑。 由于第 1 种技术已经废弃，本节只专注于讲解如何用 Webpack 构建使用了 Service Workers 的网页。</p><h2 id="认识-service-workers"><a href="#认识-service-workers" aria-hidden="true" class="header-anchor">#</a> 认识 Service Workers</h2><p><code>Service Workers</code> 是一个在浏览器后台运行的脚本，它生命周期完全独立于网页。它无法直接访问 DOM，但可以通过 <code>postMessage</code> 接口发送消息来和 UI 进程通信。 拦截网络请求是 Service Workers 的一个重要功能，通过它能完成离线缓存、编辑响应、过滤响应等功能。</p><p>想更深入的了解 Service Workers，推荐阅读<a href="https://developers.google.com/web/fundamentals/getting-started/primers/service-workers?hl=zh-cn" target="_blank" rel="noopener noreferrer">文章服务工作线程：简介<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><h2 id="service-workers-兼容性"><a href="#service-workers-兼容性" aria-hidden="true" class="header-anchor">#</a> Service Workers 兼容性</h2><p>目前 <code>Chrome</code>、<code>Firefox</code>、<code>Opera</code> 都已经全面支持 <code>Service Workers</code>，但对于移动端浏览器就不太乐观了，只有高版本的 Android 支持。 由于 Service Workers 无法通过注入 <code>polyfill</code> 去实现兼容，所以在你打算使用它前请先调查清楚你的网页的运行场景。</p><p>判断浏览器是否支持 Service Workers 的最简单的方法是通过以下代码：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 如果 navigator 对象上存在 serviceWorker 对象，就表示支持</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过 navigator.serviceWorker 使用</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="注册-service-workers"><a href="#注册-service-workers" aria-hidden="true" class="header-anchor">#</a> 注册 Service Workers</h2><p>要给网页接入 <code>Service Workers</code>，需要在网页加载后注册一个描述 <code>Service Workers</code> 逻辑的脚本。 代码如下：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 serviceWorker.register 注册，参数 /sw.js 为脚本文件所在的 URL 路径</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;/sw.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一旦这个脚本文件被加载，Service Workers 的安装就开始了。这个脚本被安装到浏览器中后，就算用户关闭了当前网页，它仍会存在。 也就是说 <strong>第一次打开该网页时 <code>Service Workers</code> 的逻辑不会生效，因为脚本还没有被加载和注册</strong>，但是以后再次打开该网页时脚本里的逻辑将会生效。</p><p>在 Chrome 中可以通过打开网址 <code>chrome://inspect/#service-workers</code> 来查看当前浏览器中所有注册了的 Service Workers。</p><h2 id="使用-service-workers-实现离线缓存"><a href="#使用-service-workers-实现离线缓存" aria-hidden="true" class="header-anchor">#</a> 使用 Service Workers 实现离线缓存</h2><p>Service Workers 在注册成功后会在其生命周期中派发出一些事件，通过监听对应的事件在特点的时间节点上做一些事情。</p><p>在 Service Workers 脚本中，引入了新的关键字 <code>self</code> 代表当前的 Service Workers 实例。</p><p>在 Service Workers 安装成功后会派发出 <code>install</code> 事件，需要在这个事件中执行缓存资源的逻辑，实现代码如下：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当前缓存版本的唯一标识符，用当前时间代替</span>
<span class="token keyword">var</span> cacheKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 需要被缓存的文件的 URL 列表</span>
<span class="token keyword">var</span> cacheFileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/app.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/app.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 监听 install 事件</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;install&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 等待所有资源缓存完成时，才可以进行下一步</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 要缓存的文件 URL 列表</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>cacheFileList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来需要监听网络请求事件去拦截请求，复用缓存，代码如下：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    <span class="token comment">// 去缓存中查询对应的请求</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果命中本地缓存，就直接返回本地的资源</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 否则就去用 fetch 下载资源</span>
      <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上就实现了<strong>离线缓存</strong>。</p><h2 id="更新缓存"><a href="#更新缓存" aria-hidden="true" class="header-anchor">#</a> 更新缓存</h2><p>线上的代码有时需要更新和重新发布，如果这个文件被离线缓存了，那就需要 <code>Service Workers</code> 脚本中有对应的逻辑去更新缓存。 这可以通过更新 <code>Service Workers</code> 脚本文件做到。</p><p>浏览器针对 Service Workers 有如下机制：</p><ol><li>每次打开接入了 Service Workers 的网页时，浏览器都会去重新下载 Service Workers 脚本文件（所以要注意该脚本文件不能太大），如果发现和当前已经注册过的文件存在字节差异，就将其视为“新服务工作线程”。</li><li>新 Service Workers 线程将会启动，且将会触发其 <code>install</code> 事件。</li><li>当网站上当前打开的页面关闭时，旧 <code>Service Workers</code> 线程将会被终止，新 Service Workers 线程将会取得控制权。</li><li>新 <code>Service Workers</code> 线程取得控制权后，将会触发其 <code>activate</code> 事件。</li></ol><p>新 Service Workers 线程中的 <code>activate</code> 事件就是最佳的清理旧缓存的时间点，代码如下：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当前缓存白名单，在新脚本的 install 事件里将使用白名单里的 key</span>
<span class="token keyword">var</span> cacheWhitelist <span class="token operator">=</span> <span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;activate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        cacheNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 不在白名单的缓存全部清理掉</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheWhitelist<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除缓存</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最终完整的代码 Service Workers 脚本代码如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当前缓存版本的唯一标识符，用当前时间代替</span>
<span class="token keyword">var</span> cacheKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 当前缓存白名单，在新脚本的 install 事件里将使用白名单里的 key</span>
<span class="token keyword">var</span> cacheWhitelist <span class="token operator">=</span> <span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 需要被缓存的文件的 URL 列表</span>
<span class="token keyword">var</span> cacheFileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;app.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 监听 install 事件</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;install&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 等待所有资源缓存完成时，才可以进行下一步</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 要缓存的文件 URL 列表</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>cacheFileList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 拦截网络请求</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    <span class="token comment">// 去缓存中查询对应的请求</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果命中本地缓存，就直接返回本地的资源</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 否则就去用 fetch 下载资源</span>
      <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 新 Service Workers 线程取得控制权后，将会触发其 activate 事件</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;activate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        cacheNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 不在白名单的缓存全部清理掉</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheWhitelist<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除缓存</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="接入-webpack"><a href="#接入-webpack" aria-hidden="true" class="header-anchor">#</a> 接入 Webpack</h2><p>用 Webpack 构建接入 Service Workers 的离线应用要解决的关键问题在于 <strong>如何生成上面提到的 <code>sw.js</code> 文件</strong>， 并且<code>sw.js</code>文件中的 <code>cacheFileList</code> 变量，代表需要被缓存文件的 URL 列表，需要根据输出文件列表所对应的 URL 来决定，而不是像上面那样写成静态值。</p><p>假如构建输出的文件目录结构为：</p><div class="language-bash extra-class"><pre class="language-bash"><code>├── app_4c3e186f.js
├── app_7cc98ad0.css
└── index.html
</code></pre></div><p>那么 <code>sw.js</code> 文件中 <code>cacheFileList</code> 的值应该是：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> cacheFileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;app_4c3e186f.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;app_7cc98ad0.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>Webpack 没有原生功能能完成以上要求，幸好庞大的社区中已经有人为我们做好了一个插件 <code>serviceworker-webpack-plugin</code> 可以方便的解决以上问题。 使用该插件后的 Webpack 配置如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ExtractTextPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;extract-text-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> WebPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;web-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ServiceWorkerWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;serviceworker-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">:</span> <span class="token string">&quot;./main.js&quot;</span> <span class="token comment">// Chunk app 的 JS 执行入口文件</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;[name].js&quot;</span><span class="token punctuation">,</span>
    publicPath<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.css/</span><span class="token punctuation">,</span> <span class="token comment">// 增加对 CSS 文件的支持</span>
        <span class="token comment">// 提取出 Chunk 中的 CSS 代码到单独的文件中</span>
        use<span class="token punctuation">:</span> ExtractTextPlugin<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">]</span> <span class="token comment">// 压缩 CSS 代码</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 一个 WebPlugin 对应一个 HTML 文件</span>
    <span class="token keyword">new</span> <span class="token class-name">WebPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token punctuation">:</span> <span class="token string">&quot;./template.html&quot;</span><span class="token punctuation">,</span> <span class="token comment">// HTML 模版文件所在的文件路径</span>
      filename<span class="token punctuation">:</span> <span class="token string">&quot;index.html&quot;</span> <span class="token comment">// 输出的 HTML 的文件名称</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ExtractTextPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      filename<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[name].css</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 给输出的 CSS 文件名称加上 Hash 值</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ServiceWorkerWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 自定义的 sw.js 文件所在路径</span>
      <span class="token comment">// ServiceWorkerWebpackPlugin 会把文件列表注入到生成的 sw.js 中</span>
      entry<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;sw.js&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Service Workers 依赖 HTTPS，使用 DevServer 提供的 HTTPS 功能。</span>
    https<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>以上配置有 2 点需要注意：</p><ul><li><p>由于 Service Workers <strong>必须在 HTTPS 环境下</strong>才能拦截网络请求实现离线缓存，使用在 <a href="/webpackLearn/setting/setting-2.html">DevServer</a><code>https</code> 中提到的方式去实现 HTTPS 服务。</p></li><li><p><code>serviceworker-webpack-plugin</code> 插件为了保证灵活性，允许使用者自定义 <code>sw.js</code>，构建输出的 <code>sw.js</code> 文件中会在头部注入一个变量 <code>serviceWorkerOption.assets</code> 到全局，里面存放着所有需要被缓存的文件的 URL 列表。</p></li></ul><p>需要修改上面的 <code>sw.js</code> 文件中写成了静态值的 <code>cacheFileList</code> 为如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 需要被缓存的文件的 URL 列表</span>
<span class="token keyword">var</span> cacheFileList <span class="token operator">=</span> global<span class="token punctuation">.</span>serviceWorkerOption<span class="token punctuation">.</span>assets<span class="token punctuation">;</span>
</code></pre></div><p>以上已经完成所有文件的修改，在重新构建前，先安装新引入的依赖：</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i -D serviceworker-webpack-plugin webpack-dev-server
</code></pre></div><p>安装成功后，在项目根目录下执行 <code>webpack-dev-server</code> 命令后，DevServer 将以 <code>HTTPS</code> 模式启动，并输出如下日志：</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> webpack-dev-server

Project is running at https://localhost:8080/
webpack output is served from /
Hash: 402ee6ce5bffb16dffe2
Version: webpack <span class="token number">3.5</span>.5
Time: 619ms
     Asset       Size  Chunks                    Chunk Names
    app.js     <span class="token number">325</span> kB       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  <span class="token punctuation">[</span>big<span class="token punctuation">]</span>  app
   app.css   <span class="token number">21</span> bytes       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         app
index.html  <span class="token number">235</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>
     sw.js    <span class="token number">4.86</span> kB          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>
</code></pre></div><p>用 Chrome 浏览器打开网址 <code>https://localhost:8080/index.html</code> 后，就能访问接入了 Service Workers 离线缓存的页面了。</p><h2 id="验证结果"><a href="#验证结果" aria-hidden="true" class="header-anchor">#</a> 验证结果</h2><p>为了验证 Service Workers 和缓存生效了，需要通过 Chrome 的开发者工具来查看。</p><p>通过打开开发者工具的 <code>Application-Service Workers</code> 一栏，就能看到当前页面注册的 <code>Service Workers</code>，正常的效果如图：</p><p><img src="/webpackLearn/assets/img/3-14service-workers.20067e5a.png" alt="图3.12.1 查看当前页面注册的 Service Workers"></p><p>通过打开开发者工具的 <code>Application-Cache-Cache Storage</code> 一栏，能看到当前页面缓存的资源列表，正常的效果如图：</p><p><img src="/webpackLearn/assets/img/3-14cache-storage.535f49e3.png" alt="图3.12.2 查看当前页面的 Cache Storage"></p><p>为了验证网页在离线时能访问的能力，需要在开发者工具中的 Network 一栏中通过 <code>Offline</code> 选项禁用掉网络，再刷新页面能正常访问，并且网络请求的响应都来自 <code>Service Workers</code>，正常的效果如图：</p><p><img src="/webpackLearn/assets/img/3-14sw-offline.354b41de.png" alt="图3.12.3 离线情况下访问页面"></p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/webpackLearn/practice/practice-13.html" class="prev">
          构建Npm模块
        </a></span><span class="next"><a href="/webpackLearn/practice/practice-15.html">
          搭配Npm Script
        </a> →
      </span></p></div></div></div></div>
    <script src="/webpackLearn/assets/js/app.77d280ee.js" defer></script><script src="/webpackLearn/assets/js/4.7fbde3f9.js" defer></script>
  </body>
</html>
