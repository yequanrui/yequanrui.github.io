<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4-5 使用自动刷新 | 深入浅出Webpack</title>
    <meta name="description" content="webpack使用学习(吴浩麟版)">
    <link rel="icon" href="/webpackLearn/favicon.ico">
  <link rel="manifest" href="/webpackLearn/manifest.json">
    
    <link rel="preload" href="/webpackLearn/assets/css/styles.77d280ee.css" as="style"><link rel="preload" href="/webpackLearn/assets/js/app.77d280ee.js" as="script"><link rel="preload" href="/webpackLearn/assets/js/5.7aab97c6.js" as="script"><link rel="prefetch" href="/webpackLearn/assets/js/1.f37f7214.js"><link rel="prefetch" href="/webpackLearn/assets/js/10.15a163ee.js"><link rel="prefetch" href="/webpackLearn/assets/js/11.d8cde28c.js"><link rel="prefetch" href="/webpackLearn/assets/js/12.6e485d95.js"><link rel="prefetch" href="/webpackLearn/assets/js/13.8167464c.js"><link rel="prefetch" href="/webpackLearn/assets/js/14.7e75c412.js"><link rel="prefetch" href="/webpackLearn/assets/js/15.593f55f2.js"><link rel="prefetch" href="/webpackLearn/assets/js/16.31248cfb.js"><link rel="prefetch" href="/webpackLearn/assets/js/17.c428f9be.js"><link rel="prefetch" href="/webpackLearn/assets/js/18.1a442e25.js"><link rel="prefetch" href="/webpackLearn/assets/js/19.d2aaef13.js"><link rel="prefetch" href="/webpackLearn/assets/js/2.d7cdf3d2.js"><link rel="prefetch" href="/webpackLearn/assets/js/20.d7645fb0.js"><link rel="prefetch" href="/webpackLearn/assets/js/21.d80e0286.js"><link rel="prefetch" href="/webpackLearn/assets/js/22.b41f3cbc.js"><link rel="prefetch" href="/webpackLearn/assets/js/23.f8779f82.js"><link rel="prefetch" href="/webpackLearn/assets/js/24.958d3c85.js"><link rel="prefetch" href="/webpackLearn/assets/js/25.2e076f51.js"><link rel="prefetch" href="/webpackLearn/assets/js/26.eff2c3e5.js"><link rel="prefetch" href="/webpackLearn/assets/js/27.40064e0e.js"><link rel="prefetch" href="/webpackLearn/assets/js/28.9ad06b95.js"><link rel="prefetch" href="/webpackLearn/assets/js/29.3a0865a0.js"><link rel="prefetch" href="/webpackLearn/assets/js/3.128b6292.js"><link rel="prefetch" href="/webpackLearn/assets/js/30.25c4f77e.js"><link rel="prefetch" href="/webpackLearn/assets/js/31.80207808.js"><link rel="prefetch" href="/webpackLearn/assets/js/32.20b8aa68.js"><link rel="prefetch" href="/webpackLearn/assets/js/33.414db07e.js"><link rel="prefetch" href="/webpackLearn/assets/js/34.3c015b40.js"><link rel="prefetch" href="/webpackLearn/assets/js/35.cfff3ee7.js"><link rel="prefetch" href="/webpackLearn/assets/js/36.5693324e.js"><link rel="prefetch" href="/webpackLearn/assets/js/37.11302d4c.js"><link rel="prefetch" href="/webpackLearn/assets/js/38.5f09cd6d.js"><link rel="prefetch" href="/webpackLearn/assets/js/39.b8a318d2.js"><link rel="prefetch" href="/webpackLearn/assets/js/4.7fbde3f9.js"><link rel="prefetch" href="/webpackLearn/assets/js/40.010eca0d.js"><link rel="prefetch" href="/webpackLearn/assets/js/41.ed550296.js"><link rel="prefetch" href="/webpackLearn/assets/js/42.bf111eba.js"><link rel="prefetch" href="/webpackLearn/assets/js/43.4178a489.js"><link rel="prefetch" href="/webpackLearn/assets/js/44.f9b7d3d8.js"><link rel="prefetch" href="/webpackLearn/assets/js/45.4aa3e07a.js"><link rel="prefetch" href="/webpackLearn/assets/js/46.766fddaf.js"><link rel="prefetch" href="/webpackLearn/assets/js/47.7a16de60.js"><link rel="prefetch" href="/webpackLearn/assets/js/48.ec0b2eb5.js"><link rel="prefetch" href="/webpackLearn/assets/js/49.9ba3c919.js"><link rel="prefetch" href="/webpackLearn/assets/js/50.fe7bdfef.js"><link rel="prefetch" href="/webpackLearn/assets/js/51.b5d4459d.js"><link rel="prefetch" href="/webpackLearn/assets/js/52.aa5814ff.js"><link rel="prefetch" href="/webpackLearn/assets/js/53.8ad00778.js"><link rel="prefetch" href="/webpackLearn/assets/js/54.92f9cbd1.js"><link rel="prefetch" href="/webpackLearn/assets/js/55.d04ea61a.js"><link rel="prefetch" href="/webpackLearn/assets/js/56.4b17dc92.js"><link rel="prefetch" href="/webpackLearn/assets/js/57.82800a68.js"><link rel="prefetch" href="/webpackLearn/assets/js/58.b4482327.js"><link rel="prefetch" href="/webpackLearn/assets/js/59.40bf3560.js"><link rel="prefetch" href="/webpackLearn/assets/js/6.e891bd55.js"><link rel="prefetch" href="/webpackLearn/assets/js/60.3a147a38.js"><link rel="prefetch" href="/webpackLearn/assets/js/61.9fab59f3.js"><link rel="prefetch" href="/webpackLearn/assets/js/62.7aacd083.js"><link rel="prefetch" href="/webpackLearn/assets/js/63.7e09e4d8.js"><link rel="prefetch" href="/webpackLearn/assets/js/64.b3113e47.js"><link rel="prefetch" href="/webpackLearn/assets/js/65.d1030852.js"><link rel="prefetch" href="/webpackLearn/assets/js/66.799e920a.js"><link rel="prefetch" href="/webpackLearn/assets/js/67.a898b698.js"><link rel="prefetch" href="/webpackLearn/assets/js/68.92cd43e9.js"><link rel="prefetch" href="/webpackLearn/assets/js/69.262008ea.js"><link rel="prefetch" href="/webpackLearn/assets/js/7.22611dc1.js"><link rel="prefetch" href="/webpackLearn/assets/js/70.afff8df7.js"><link rel="prefetch" href="/webpackLearn/assets/js/71.7818a2c2.js"><link rel="prefetch" href="/webpackLearn/assets/js/8.5b18428a.js"><link rel="prefetch" href="/webpackLearn/assets/js/9.9ef066a0.js">
    <link rel="stylesheet" href="/webpackLearn/assets/css/styles.77d280ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/webpackLearn/" class="home-link router-link-active"><!----><span class="site-name">
      深入浅出Webpack
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/webpackLearn/" class="nav-link">首页</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webpackLearn/" class="nav-link">首页</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>入门</span><!----></p><ul class="sidebar-group-items"><li><a href="/webpackLearn/intro.html" class="sidebar-link">前言</a></li><li><a href="/webpackLearn/intro/intro-1.html" class="sidebar-link">前端的发展</a></li><li><a href="/webpackLearn/intro/intro-2.html" class="sidebar-link">前端常用构建工具</a></li><li><a href="/webpackLearn/intro/intro-3.html" class="sidebar-link">webpack安装使用</a></li><li><a href="/webpackLearn/intro/intro-4.html" class="sidebar-link">使用Loader</a></li><li><a href="/webpackLearn/intro/intro-5.html" class="sidebar-link">使用Plugin</a></li><li><a href="/webpackLearn/intro/intro-6.html" class="sidebar-link">使用DevServer</a></li><li><a href="/webpackLearn/intro/intro-7.html" class="sidebar-link">核心概念</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>配置</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>实战</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>优化</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/webpackLearn/optimize/optimize-1.html" class="sidebar-link">缩小文件搜索范围</a></li><li><a href="/webpackLearn/optimize/optimize-2.html" class="sidebar-link">使用Dll Plugin</a></li><li><a href="/webpackLearn/optimize/optimize-3.html" class="sidebar-link">使用 HappyPack</a></li><li><a href="/webpackLearn/optimize/optimize-4.html" class="sidebar-link">使用 ParallelUglifyPlugin</a></li><li><a href="/webpackLearn/optimize/optimize-5.html" class="active sidebar-link">使用自动刷新</a></li><li><a href="/webpackLearn/optimize/optimize-6.html" class="sidebar-link">开启模块热替换</a></li><li><a href="/webpackLearn/optimize/optimize-7.html" class="sidebar-link">区分环境</a></li><li><a href="/webpackLearn/optimize/optimize-8.html" class="sidebar-link">压缩代码</a></li><li><a href="/webpackLearn/optimize/optimize-9.html" class="sidebar-link">CDN加速</a></li><li><a href="/webpackLearn/optimize/optimize-10.html" class="sidebar-link">使用Tree Shaking</a></li><li><a href="/webpackLearn/optimize/optimize-11.html" class="sidebar-link">提取公共代码</a></li><li><a href="/webpackLearn/optimize/optimize-12.html" class="sidebar-link">按需加载</a></li><li><a href="/webpackLearn/optimize/optimize-13.html" class="sidebar-link">使用PrePack</a></li><li><a href="/webpackLearn/optimize/optimize-14.html" class="sidebar-link">开启Scope Hoisting</a></li><li><a href="/webpackLearn/optimize/optimize-15.html" class="sidebar-link">输出分析</a></li><li><a href="/webpackLearn/optimize/optimize-16.html" class="sidebar-link">优化总结</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>原理</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>附录</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="_4-5-使用自动刷新"><a href="#_4-5-使用自动刷新" aria-hidden="true" class="header-anchor">#</a> 4-5 使用自动刷新</h1><p>在开发阶段，修改源码是不可避免的操作。 对于开发网页来说，要想看到修改后的效果，需要刷新浏览器让其重新运行最新的代码才行。 虽然这相比于开发原生 iOS 和 Android 应用来说要方便很多，因为那需要重新编译这个项目再运行，但我们可以把这个体验优化的更好。 借助自动化的手段，可以把这些重复的操作交给代码去帮我们完成，在监听到本地源码文件发生变化时，自动重新构建出可运行的代码后再控制浏览器刷新。</p><p>Webpack 把这些功能都内置了，并且还提供多种方案可选。</p><h2 id="文件监听"><a href="#文件监听" aria-hidden="true" class="header-anchor">#</a> 文件监听</h2><p>文件监听是在发现源码文件发生变化时，自动重新构建出新的输出文件。</p><p>Webpack 官方提供了两大模块，一个是核心的 webpack，一个是在<a href="/webpackLearn/intro/intro-6.html">使用 DevServer</a>中提到的 <code>webpack-dev-server</code> 扩展模块。 而文件监听功能是 webpack 模块提供的。</p><p>在<a href="/webpackLearn/setting/setting-7.html">其它配置项 </a> 中曾介绍过 Webpack 支持文件监听相关的配置项如下：</p><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只有在开启监听模式时，watchOptions 才有意义</span>
  <span class="token comment">// 默认为 false，也就是不开启</span>
  watch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 监听模式运行时的参数</span>
  <span class="token comment">// 在开启监听模式时，才有意义</span>
  watchOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不监听的文件或文件夹，支持正则匹配</span>
    <span class="token comment">// 默认为空</span>
    ignored<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
    <span class="token comment">// 监听到变化发生后会等300ms再去执行动作，防止文件更新太快导致重新编译频率太高</span>
    <span class="token comment">// 默认为 300ms</span>
    aggregateTimeout<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token comment">// 判断文件是否发生变化是通过不停的去询问系统指定文件有没有变化实现的</span>
    <span class="token comment">// 默认每秒问 1000 次</span>
    poll<span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>要让 Webpack 开启监听模式，有两种方式：</p><ul><li>在配置文件 <code>webpack.config.js</code> 中设置 <code>watch: true</code>。</li><li>在执行启动 Webpack 命令时，带上 <code>--watch</code> 参数，完整命令是 <code>webpack --watch</code>。</li></ul><h2 id="文件监听工作原理"><a href="#文件监听工作原理" aria-hidden="true" class="header-anchor">#</a> 文件监听工作原理</h2><p>在 Webpack 中监听一个文件发生变化的原理是定时的去获取这个文件的最后编辑时间，每次都存下最新的最后编辑时间，如果发现当前获取的和最后一次保存的最后编辑时间不一致，就认为该文件发生了变化。 配置项中的 <code>watchOptions.poll</code> 就是用于控制定时检查的周期，具体含义是每秒检查多少次。</p><p>当发现某个文件发生了变化时，并不会立刻告诉监听者，而是先缓存起来，收集一段时间的变化后，再一次性告诉监听者。 配置项中的 <code>watchOptions.aggregateTimeout</code> 就是用于配置这个等待时间。 这样做的目的是因为我们在编辑代码的过程中可能会高频的输入文字导致文件变化的事件高频的发生，如果每次都重新执行构建就会让构建卡死。</p><p>对于多个文件来说，原理相似，只不过会对列表中的每一个文件都定时的执行检查。 但是这个需要监听的文件列表是怎么确定的呢？ 默认情况下 Webpack 会从配置的 <code>Entry</code> 文件出发，递归解析出 <code>Entry</code> 文件所依赖的文件，把这些依赖的文件都加入到监听列表中去。 可见 Webpack 这一点还是做的很智能的，不是粗暴的直接监听项目目录下的所有文件。</p><p>由于保存文件的路径和最后编辑时间需要占用内存，定时检查周期检查需要占用 CPU 以及文件 I/O，所以最好减少需要监听的文件数量和降低检查频率。</p><h2 id="优化文件监听性能"><a href="#优化文件监听性能" aria-hidden="true" class="header-anchor">#</a> 优化文件监听性能</h2><p>在明白文件监听工作原理后，就好分析如何优化文件监听性能了。</p><p>开启监听模式时，默认情况下会监听配置的 <code>Entry</code> 文件和所有其递归依赖的文件。 在这些文件中会有很多存在于 <code>node_modules</code> 下，因为如今的 Web 项目会依赖大量的第三方模块。</p><p>在大多数情况下我们都不可能去编辑 <code>node_modules</code> 下的文件，而是编辑自己建立的源码文件。 所以一个很大的优化点就是忽略掉 <code>node_modules</code>下的文件，不监听它们。相关配置如下：</p><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>
  watchOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不监听的 node_modules 目录下的文件</span>
    ignored<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>采用这种方法优化后，你的 Webpack 消耗的内存和 CPU 将会大大降低。</p><blockquote><p>有时你可能会觉得 <code>node_modules</code> 目录下的第三方模块有 bug，想修改第三方模块的文件，然后在自己的项目中试试。 在这种情况下如果使用了以上优化方法，我们需要重启构建以看到最新效果。 <strong>但这种情况毕竟是非常少见的</strong>。</p></blockquote><p>除了忽略掉部分文件的优化外，还有如下两种方法：</p><ul><li><code>watchOptions.aggregateTimeout</code> 值越大性能越好，因为这能降低重新构建的频率。</li><li><code>watchOptions.poll</code> 值越小越好，因为这能降低检查的频率。</li></ul><p>但两种优化方法的后果是会让你感觉到监听模式的反应和灵敏度降低了。</p><h2 id="自动刷新浏览器"><a href="#自动刷新浏览器" aria-hidden="true" class="header-anchor">#</a> 自动刷新浏览器</h2><p>监听到文件更新后的下一步是去刷新浏览器，webpack 模块负责监听文件，<code>webpack-dev-server</code> 模块则负责刷新浏览器。 在使用 <code>webpack-dev-server</code> 模块去启动 <code>webpack</code> 模块时，<code>webpack</code> 模块的监听模式默认会被开启。 <strong>webpack 模块会在文件发生变化时告诉 webpack-dev-server 模块</strong>。</p><h2 id="自动刷新的原理"><a href="#自动刷新的原理" aria-hidden="true" class="header-anchor">#</a> 自动刷新的原理</h2><p>控制浏览器刷新有三种方法：</p><ol><li>借助浏览器扩展去通过浏览器提供的接口刷新，WebStorm IDE 的 LiveEdit 功能就是这样实现的。</li><li>往要开发的网页中[注入代理客户端]代码，通过代理客户端去刷新整个页面。</li><li>把要开发的网页装进一个 <code>iframe</code> 中，通过刷新 <code>iframe</code> 去看到最新效果。</li></ol><p>DevServer 支持第 2、3 种方法，第 2 种是 DevServer 默认采用的刷新方法。</p><p>通过 DevServer 启动构建后，你会看到如下日志：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&gt;</span> webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server

Project is running at http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token regex">/localhost:8080/</span>
webpack output is served <span class="token keyword">from</span> <span class="token operator">/</span>
Hash<span class="token punctuation">:</span> e4e2f9508ac286037e71
Version<span class="token punctuation">:</span> webpack <span class="token number">3.5</span><span class="token number">.5</span>
Time<span class="token punctuation">:</span> <span class="token number">1566</span>ms
        Asset     Size  Chunks                    Chunk Names
    bundle<span class="token punctuation">.</span>js  <span class="token number">1.07</span> <span class="token constant">MB</span>       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  <span class="token punctuation">[</span>big<span class="token punctuation">]</span>  main
bundle<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map  <span class="token number">1.27</span> <span class="token constant">MB</span>       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         main
 <span class="token punctuation">[</span><span class="token number">115</span><span class="token punctuation">]</span> <span class="token function">multi</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">?</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>js <span class="token number">40</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">?</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token number">5.83</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">117</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>url<span class="token operator">/</span>url<span class="token punctuation">.</span>js <span class="token number">23.3</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>querystring<span class="token operator">-</span>es3<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">127</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>strip<span class="token operator">-</span>ansi<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">161</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">125</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>loglevel<span class="token operator">/</span>lib<span class="token operator">/</span>loglevel<span class="token punctuation">.</span>js <span class="token number">6.74</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">126</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>socket<span class="token punctuation">.</span>js <span class="token number">856</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">158</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>overlay<span class="token punctuation">.</span>js <span class="token number">3.6</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">159</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>ansi<span class="token operator">-</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">4.26</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">163</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot nonrecursive <span class="token operator">^</span>\<span class="token punctuation">.</span>\<span class="token operator">/</span>log$ <span class="token number">170</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">165</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot<span class="token operator">/</span>emitter<span class="token punctuation">.</span>js <span class="token number">77</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">167</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>js <span class="token number">2.28</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
    <span class="token operator">+</span> <span class="token number">255</span> hidden modules
</code></pre></div><p>细心的你会观察到输出的 <code>bundle.js</code>中包含了以下七个模块：</p><div class="language-js extra-class"><pre class="language-js"><code> <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">?</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token number">5.83</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">117</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>url<span class="token operator">/</span>url<span class="token punctuation">.</span>js <span class="token number">23.3</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>querystring<span class="token operator">-</span>es3<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">127</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>strip<span class="token operator">-</span>ansi<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">161</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">125</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>loglevel<span class="token operator">/</span>lib<span class="token operator">/</span>loglevel<span class="token punctuation">.</span>js <span class="token number">6.74</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">126</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>socket<span class="token punctuation">.</span>js <span class="token number">856</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">158</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>overlay<span class="token punctuation">.</span>js <span class="token number">3.6</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
</code></pre></div><p>这七个模块就是代理客户端的代码，它们被打包进了要开发的网页代码中。</p><p>在浏览器中打开网址 <code>http://localhost:8080/</code> 后， 在浏览器的开发者工具中你会发现由代理客户端向 DevServer 发起的 WebSocket 连接：</p><p><img src="/webpackLearn/assets/img/4-5inline-client-websocket.c8fb9879.png" alt="图4.5.1 代理客户端发起 WebSocket 连接"></p><h2 id="优化自动刷新的性能"><a href="#优化自动刷新的性能" aria-hidden="true" class="header-anchor">#</a> 优化自动刷新的性能</h2><p>在<a href="/webpackLearn/setting/setting-6.html">DevServer</a>中曾介绍过 <code>devServer.inline</code> 配置项，它就是用来控制是否往 Chunk 中注入代理客户端的，默认会注入。 事实上，在开启 <code>inline</code> 时，DevServer 会为每个输出的 <code>Chunk</code> 中注入代理客户端的代码，当你的项目需要输出的 Chunk 有很多个时，这会导致你的构建缓慢。</p><p><strong>其实要完成自动刷新，一个页面只需要一个代理客户端就行了</strong>，DevServer 之所以粗暴的为每个 Chunk 都注入，是因为它不知道某个网页依赖哪几个 Chunk，索性就全部都注入一个代理客户端。 网页只要依赖了其中任何一个 Chunk，代理客户端就被注入到网页中去。</p><p>这里优化的思路是关闭还不够优雅的 <code>inline</code> 模式，只注入一个代理客户端。</p><p>为了关闭 <code>inline</code>模式，在启动 DevServer 时，可通过执行命令 <code>webpack-dev-server --inline false</code>（也可以在配置文件中设置），这时输出的日志如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&gt;</span> webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server <span class="token operator">--</span>inline <span class="token boolean">false</span>

Project is running at http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>
webpack output is served <span class="token keyword">from</span> <span class="token operator">/</span>
Hash<span class="token punctuation">:</span> <span class="token number">5</span>a43fc44b5e85f4c2cf1
Version<span class="token punctuation">:</span> webpack <span class="token number">3.5</span><span class="token number">.5</span>
Time<span class="token punctuation">:</span> <span class="token number">1130</span>ms
        Asset    Size  Chunks                    Chunk Names
    bundle<span class="token punctuation">.</span>js  <span class="token number">750</span> kB       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  <span class="token punctuation">[</span>big<span class="token punctuation">]</span>  main
bundle<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map  <span class="token number">897</span> kB       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         main
  <span class="token punctuation">[</span><span class="token number">81</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>js <span class="token number">2.29</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
    <span class="token operator">+</span> <span class="token number">169</span> hidden modules
</code></pre></div><p>和前面的不同在于</p><ul><li>入口网址变成了 <code>http://localhost:8080/webpack-dev-server/</code></li><li><code>bundle.js</code> 中不再包含代理客户端的代码了</li></ul><p>在浏览器中打开网址 <code>http://localhost:8080/webpack-dev-server/</code> 后，你会看到如下效果：</p><p><img src="/webpackLearn/assets/img/4-5iframe-reload.9ad321df.png" alt="图4.5.2 通过 iframe 自动刷新"></p><p>要开发的网页被放进了一个 <code>iframe</code> 中，编辑源码后，<code>iframe</code> 会被自动刷新。 同时你会发现构建时间从 1566ms 减少到了 1130ms，说明优化生效了。构建性能提升的效果在要输出的 Chunk 数量越多时会显得越突出。</p><blockquote><p>在你关闭了 inline 后，DevServer 会自动地提示你通过新网址 http://localhost:8080/webpack-dev-server/ 去访问，这点是做的很人心化的。</p></blockquote><p>如果你不想通过 <code>iframe</code> 的方式去访问，但同时又想让网页保持自动刷新功能，你需要手动往网页中注入代理客户端脚本，往 <code>index.html</code> 中插入以下标签：</p><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!--注入 DevServer 提供的代理客户端脚本，这个服务是 DevServer 内置的--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://localhost:8080/webpack-dev-server.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>给网页注入以上脚本后，独立打开的网页就能自动刷新了。但是要注意在发布到线上时记得删除掉这段用于开发环境的代码。</p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/webpackLearn/optimize/optimize-4.html" class="prev">
          使用 ParallelUglifyPlugin
        </a></span><span class="next"><a href="/webpackLearn/optimize/optimize-6.html">
          开启模块热替换
        </a> →
      </span></p></div></div></div></div>
    <script src="/webpackLearn/assets/js/app.77d280ee.js" defer></script><script src="/webpackLearn/assets/js/5.7aab97c6.js" defer></script>
  </body>
</html>
