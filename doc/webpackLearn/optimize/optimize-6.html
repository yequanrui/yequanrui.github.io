<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4-6 开启模块热替换 | 深入浅出Webpack</title>
    <meta name="description" content="webpack使用学习(吴浩麟版)">
    <link rel="icon" href="/webpackLearn/favicon.ico">
  <link rel="manifest" href="/webpackLearn/manifest.json">
    
    <link rel="preload" href="/webpackLearn/assets/css/styles.77d280ee.css" as="style"><link rel="preload" href="/webpackLearn/assets/js/app.77d280ee.js" as="script"><link rel="preload" href="/webpackLearn/assets/js/3.128b6292.js" as="script"><link rel="prefetch" href="/webpackLearn/assets/js/1.f37f7214.js"><link rel="prefetch" href="/webpackLearn/assets/js/10.15a163ee.js"><link rel="prefetch" href="/webpackLearn/assets/js/11.d8cde28c.js"><link rel="prefetch" href="/webpackLearn/assets/js/12.6e485d95.js"><link rel="prefetch" href="/webpackLearn/assets/js/13.8167464c.js"><link rel="prefetch" href="/webpackLearn/assets/js/14.7e75c412.js"><link rel="prefetch" href="/webpackLearn/assets/js/15.593f55f2.js"><link rel="prefetch" href="/webpackLearn/assets/js/16.31248cfb.js"><link rel="prefetch" href="/webpackLearn/assets/js/17.c428f9be.js"><link rel="prefetch" href="/webpackLearn/assets/js/18.1a442e25.js"><link rel="prefetch" href="/webpackLearn/assets/js/19.d2aaef13.js"><link rel="prefetch" href="/webpackLearn/assets/js/2.d7cdf3d2.js"><link rel="prefetch" href="/webpackLearn/assets/js/20.d7645fb0.js"><link rel="prefetch" href="/webpackLearn/assets/js/21.d80e0286.js"><link rel="prefetch" href="/webpackLearn/assets/js/22.b41f3cbc.js"><link rel="prefetch" href="/webpackLearn/assets/js/23.f8779f82.js"><link rel="prefetch" href="/webpackLearn/assets/js/24.958d3c85.js"><link rel="prefetch" href="/webpackLearn/assets/js/25.2e076f51.js"><link rel="prefetch" href="/webpackLearn/assets/js/26.eff2c3e5.js"><link rel="prefetch" href="/webpackLearn/assets/js/27.40064e0e.js"><link rel="prefetch" href="/webpackLearn/assets/js/28.9ad06b95.js"><link rel="prefetch" href="/webpackLearn/assets/js/29.3a0865a0.js"><link rel="prefetch" href="/webpackLearn/assets/js/30.25c4f77e.js"><link rel="prefetch" href="/webpackLearn/assets/js/31.80207808.js"><link rel="prefetch" href="/webpackLearn/assets/js/32.20b8aa68.js"><link rel="prefetch" href="/webpackLearn/assets/js/33.414db07e.js"><link rel="prefetch" href="/webpackLearn/assets/js/34.3c015b40.js"><link rel="prefetch" href="/webpackLearn/assets/js/35.cfff3ee7.js"><link rel="prefetch" href="/webpackLearn/assets/js/36.5693324e.js"><link rel="prefetch" href="/webpackLearn/assets/js/37.11302d4c.js"><link rel="prefetch" href="/webpackLearn/assets/js/38.5f09cd6d.js"><link rel="prefetch" href="/webpackLearn/assets/js/39.b8a318d2.js"><link rel="prefetch" href="/webpackLearn/assets/js/4.7fbde3f9.js"><link rel="prefetch" href="/webpackLearn/assets/js/40.010eca0d.js"><link rel="prefetch" href="/webpackLearn/assets/js/41.ed550296.js"><link rel="prefetch" href="/webpackLearn/assets/js/42.bf111eba.js"><link rel="prefetch" href="/webpackLearn/assets/js/43.4178a489.js"><link rel="prefetch" href="/webpackLearn/assets/js/44.f9b7d3d8.js"><link rel="prefetch" href="/webpackLearn/assets/js/45.4aa3e07a.js"><link rel="prefetch" href="/webpackLearn/assets/js/46.766fddaf.js"><link rel="prefetch" href="/webpackLearn/assets/js/47.7a16de60.js"><link rel="prefetch" href="/webpackLearn/assets/js/48.ec0b2eb5.js"><link rel="prefetch" href="/webpackLearn/assets/js/49.9ba3c919.js"><link rel="prefetch" href="/webpackLearn/assets/js/5.7aab97c6.js"><link rel="prefetch" href="/webpackLearn/assets/js/50.fe7bdfef.js"><link rel="prefetch" href="/webpackLearn/assets/js/51.b5d4459d.js"><link rel="prefetch" href="/webpackLearn/assets/js/52.aa5814ff.js"><link rel="prefetch" href="/webpackLearn/assets/js/53.8ad00778.js"><link rel="prefetch" href="/webpackLearn/assets/js/54.92f9cbd1.js"><link rel="prefetch" href="/webpackLearn/assets/js/55.d04ea61a.js"><link rel="prefetch" href="/webpackLearn/assets/js/56.4b17dc92.js"><link rel="prefetch" href="/webpackLearn/assets/js/57.82800a68.js"><link rel="prefetch" href="/webpackLearn/assets/js/58.b4482327.js"><link rel="prefetch" href="/webpackLearn/assets/js/59.40bf3560.js"><link rel="prefetch" href="/webpackLearn/assets/js/6.e891bd55.js"><link rel="prefetch" href="/webpackLearn/assets/js/60.3a147a38.js"><link rel="prefetch" href="/webpackLearn/assets/js/61.9fab59f3.js"><link rel="prefetch" href="/webpackLearn/assets/js/62.7aacd083.js"><link rel="prefetch" href="/webpackLearn/assets/js/63.7e09e4d8.js"><link rel="prefetch" href="/webpackLearn/assets/js/64.b3113e47.js"><link rel="prefetch" href="/webpackLearn/assets/js/65.d1030852.js"><link rel="prefetch" href="/webpackLearn/assets/js/66.799e920a.js"><link rel="prefetch" href="/webpackLearn/assets/js/67.a898b698.js"><link rel="prefetch" href="/webpackLearn/assets/js/68.92cd43e9.js"><link rel="prefetch" href="/webpackLearn/assets/js/69.262008ea.js"><link rel="prefetch" href="/webpackLearn/assets/js/7.22611dc1.js"><link rel="prefetch" href="/webpackLearn/assets/js/70.afff8df7.js"><link rel="prefetch" href="/webpackLearn/assets/js/71.7818a2c2.js"><link rel="prefetch" href="/webpackLearn/assets/js/8.5b18428a.js"><link rel="prefetch" href="/webpackLearn/assets/js/9.9ef066a0.js">
    <link rel="stylesheet" href="/webpackLearn/assets/css/styles.77d280ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/webpackLearn/" class="home-link router-link-active"><!----><span class="site-name">
      深入浅出Webpack
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/webpackLearn/" class="nav-link">首页</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webpackLearn/" class="nav-link">首页</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>入门</span><!----></p><ul class="sidebar-group-items"><li><a href="/webpackLearn/intro.html" class="sidebar-link">前言</a></li><li><a href="/webpackLearn/intro/intro-1.html" class="sidebar-link">前端的发展</a></li><li><a href="/webpackLearn/intro/intro-2.html" class="sidebar-link">前端常用构建工具</a></li><li><a href="/webpackLearn/intro/intro-3.html" class="sidebar-link">webpack安装使用</a></li><li><a href="/webpackLearn/intro/intro-4.html" class="sidebar-link">使用Loader</a></li><li><a href="/webpackLearn/intro/intro-5.html" class="sidebar-link">使用Plugin</a></li><li><a href="/webpackLearn/intro/intro-6.html" class="sidebar-link">使用DevServer</a></li><li><a href="/webpackLearn/intro/intro-7.html" class="sidebar-link">核心概念</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>配置</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>实战</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>优化</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/webpackLearn/optimize/optimize-1.html" class="sidebar-link">缩小文件搜索范围</a></li><li><a href="/webpackLearn/optimize/optimize-2.html" class="sidebar-link">使用Dll Plugin</a></li><li><a href="/webpackLearn/optimize/optimize-3.html" class="sidebar-link">使用 HappyPack</a></li><li><a href="/webpackLearn/optimize/optimize-4.html" class="sidebar-link">使用 ParallelUglifyPlugin</a></li><li><a href="/webpackLearn/optimize/optimize-5.html" class="sidebar-link">使用自动刷新</a></li><li><a href="/webpackLearn/optimize/optimize-6.html" class="active sidebar-link">开启模块热替换</a></li><li><a href="/webpackLearn/optimize/optimize-7.html" class="sidebar-link">区分环境</a></li><li><a href="/webpackLearn/optimize/optimize-8.html" class="sidebar-link">压缩代码</a></li><li><a href="/webpackLearn/optimize/optimize-9.html" class="sidebar-link">CDN加速</a></li><li><a href="/webpackLearn/optimize/optimize-10.html" class="sidebar-link">使用Tree Shaking</a></li><li><a href="/webpackLearn/optimize/optimize-11.html" class="sidebar-link">提取公共代码</a></li><li><a href="/webpackLearn/optimize/optimize-12.html" class="sidebar-link">按需加载</a></li><li><a href="/webpackLearn/optimize/optimize-13.html" class="sidebar-link">使用PrePack</a></li><li><a href="/webpackLearn/optimize/optimize-14.html" class="sidebar-link">开启Scope Hoisting</a></li><li><a href="/webpackLearn/optimize/optimize-15.html" class="sidebar-link">输出分析</a></li><li><a href="/webpackLearn/optimize/optimize-16.html" class="sidebar-link">优化总结</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>原理</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>附录</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="_4-6-开启模块热替换"><a href="#_4-6-开启模块热替换" aria-hidden="true" class="header-anchor">#</a> 4-6 开启模块热替换</h1><p>要做到实时预览，除了在<a href="/webpackLearn/optimize/optimize-5.html">使用自动刷新</a> 中介绍的刷新整个网页外，DevServer 还支持一种叫做 **模块热替换(Hot Module Replacement)**的技术可在不刷新整个网页的情况下做到超灵敏的实时预览。 原理是当一个源码发生变化时，只重新编译发生变化的模块，再用新输出的模块替换掉浏览器中对应的老模块。</p><p>模块热替换技术的优势有：</p><ul><li>实时预览反应更快，等待时间更短。</li><li>不刷新浏览器能保留当前网页的运行状态，例如在使用 <code>Redux</code> 来管理数据的应用中搭配模块热替换能做到代码更新时 <code>Redux</code> 中的数据还保持不变。</li></ul><p><strong>总的来说模块热替换技术很大程度上的提高了开发效率和体验</strong>。</p><h2 id="模块热替换的原理"><a href="#模块热替换的原理" aria-hidden="true" class="header-anchor">#</a> 模块热替换的原理</h2><p>模块热替换的原理和自动刷新原理类似，都需要往要开发的网页中注入一个代理客户端用于连接 DevServer 和网页， 不同在于模块热替换独特的模块替换机制。</p><p>DevServer 默认不会开启模块热替换模式，要开启该模式，只需在启动时带上参数 <code>--hot</code>，完整命令是 <code>webpack-dev-server --hot</code>。</p><p>除了通过在启动时带上 <code>--hot</code> 参数，还可以通过接入 Plugin 实现，相关代码如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> HotModuleReplacementPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack/lib/HotModuleReplacementPlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为每个入口都注入代理客户端</span>
    main<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;webpack-dev-server/client?http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;webpack/hot/dev-server&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;./src/main.js&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 该插件的作用就是实现模块热替换，实际上当启动时带上 `--hot` 参数，会注入该插件，生成 `.hot-update.json` 文件。</span>
    <span class="token keyword">new</span> <span class="token class-name">HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 告诉 DevServer 要开启模块热替换模式</span>
    hot<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在启动 Webpack 时带上参数 <code>--hot</code>其实就是自动为你完成以上配置。</p><p>启动后日志如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&gt;</span> webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server <span class="token operator">--</span>hot

Project is running at http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token regex">/localhost:8080/</span>
webpack output is served <span class="token keyword">from</span> <span class="token operator">/</span>
webpack<span class="token punctuation">:</span> wait until bundle finished<span class="token punctuation">:</span> <span class="token operator">/</span>
webpack<span class="token punctuation">:</span> wait until bundle finished<span class="token punctuation">:</span> <span class="token operator">/</span>bundle<span class="token punctuation">.</span>js
Hash<span class="token punctuation">:</span> fe62ac6b753c1d98961b
Version<span class="token punctuation">:</span> webpack <span class="token number">3.5</span><span class="token number">.5</span>
Time<span class="token punctuation">:</span> <span class="token number">3563</span>ms
        Asset     Size  Chunks                    Chunk Names
    bundle<span class="token punctuation">.</span>js  <span class="token number">1.11</span> <span class="token constant">MB</span>       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  <span class="token punctuation">[</span>big<span class="token punctuation">]</span>  main
bundle<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map  <span class="token number">1.33</span> <span class="token constant">MB</span>       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         main
  <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot<span class="token operator">/</span>log<span class="token punctuation">.</span>js <span class="token number">1.04</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">118</span><span class="token punctuation">]</span> <span class="token function">multi</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">?</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span> webpack<span class="token operator">/</span>hot<span class="token operator">/</span>dev<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>js <span class="token number">52</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">119</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">?</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token number">5.83</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>url<span class="token operator">/</span>url<span class="token punctuation">.</span>js <span class="token number">23.3</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">126</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>strip<span class="token operator">-</span>ansi<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">161</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>loglevel<span class="token operator">/</span>lib<span class="token operator">/</span>loglevel<span class="token punctuation">.</span>js <span class="token number">6.74</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">129</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>socket<span class="token punctuation">.</span>js <span class="token number">856</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">161</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>overlay<span class="token punctuation">.</span>js <span class="token number">3.6</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">166</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot nonrecursive <span class="token operator">^</span>\<span class="token punctuation">.</span>\<span class="token operator">/</span>log$ <span class="token number">170</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">168</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot<span class="token operator">/</span>dev<span class="token operator">-</span>server<span class="token punctuation">.</span>js <span class="token number">1.61</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">169</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot<span class="token operator">/</span>log<span class="token operator">-</span>apply<span class="token operator">-</span>result<span class="token punctuation">.</span>js <span class="token number">1.31</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">170</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>js <span class="token number">2.35</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
    <span class="token operator">+</span> <span class="token number">262</span> hidden modules
</code></pre></div><p>可以看出 <code>bundle.js</code> 代理客户端相关的代码包含九个文件：</p><div class="language-js extra-class"><pre class="language-js"><code> <span class="token punctuation">[</span><span class="token number">119</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">?</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token number">5.83</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>url<span class="token operator">/</span>url<span class="token punctuation">.</span>js <span class="token number">23.3</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">126</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>strip<span class="token operator">-</span>ansi<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">161</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>loglevel<span class="token operator">/</span>lib<span class="token operator">/</span>loglevel<span class="token punctuation">.</span>js <span class="token number">6.74</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">129</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>socket<span class="token punctuation">.</span>js <span class="token number">856</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">161</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">-</span>dev<span class="token operator">-</span>server<span class="token operator">/</span>client<span class="token operator">/</span>overlay<span class="token punctuation">.</span>js <span class="token number">3.6</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">166</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot nonrecursive <span class="token operator">^</span>\<span class="token punctuation">.</span>\<span class="token operator">/</span>log$ <span class="token number">170</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">168</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot<span class="token operator">/</span>dev<span class="token operator">-</span>server<span class="token punctuation">.</span>js <span class="token number">1.61</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">169</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot<span class="token operator">/</span>log<span class="token operator">-</span>apply<span class="token operator">-</span>result<span class="token punctuation">.</span>js <span class="token number">1.31</span> kB <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
</code></pre></div><p>相比于自动刷新的代理客户端，多出了后三个用于模块热替换的文件，也就是说代理客户端更大了。</p><p>修改源码 <code>main.css</code> 文件后，新输出了如下日志：</p><div class="language-js extra-class"><pre class="language-js"><code>webpack<span class="token punctuation">:</span> Compiling<span class="token operator">...</span>
Hash<span class="token punctuation">:</span> <span class="token number">18</span>f81c959118f6230623
Version<span class="token punctuation">:</span> webpack <span class="token number">3.5</span><span class="token number">.5</span>
Time<span class="token punctuation">:</span> <span class="token number">551</span>ms
                                   Asset       Size  Chunks                    Chunk Names
                               bundle<span class="token punctuation">.</span>js    <span class="token number">1.11</span> <span class="token constant">MB</span>       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  <span class="token punctuation">[</span>big<span class="token punctuation">]</span>  main
    <span class="token number">0.</span>ea11a51f97f2b52bca7d<span class="token punctuation">.</span>hot<span class="token operator">-</span>update<span class="token punctuation">.</span>js  <span class="token number">353</span> bytes       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         main
    ea11a51f97f2b52bca7d<span class="token punctuation">.</span>hot<span class="token operator">-</span>update<span class="token punctuation">.</span>json   <span class="token number">43</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>
                           bundle<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map    <span class="token number">1.33</span> <span class="token constant">MB</span>       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         main
<span class="token number">0.</span>ea11a51f97f2b52bca7d<span class="token punctuation">.</span>hot<span class="token operator">-</span>update<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map  <span class="token number">577</span> bytes       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>         main
  <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>css<span class="token operator">-</span>loader<span class="token operator">!</span><span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span>css <span class="token number">217</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">166</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>webpack<span class="token punctuation">)</span><span class="token operator">/</span>hot nonrecursive <span class="token operator">^</span>\<span class="token punctuation">.</span>\<span class="token operator">/</span>log$ <span class="token number">170</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
    <span class="token operator">+</span> <span class="token number">275</span> hidden modules
webpack<span class="token punctuation">:</span> Compiled successfully<span class="token punctuation">.</span>
</code></pre></div><p>DevServer 新生成了一个用于替换老模块的补丁文件 <code>0.ea11a51f97f2b52bca7d.hot-update.js</code>，同时在浏览器开发工具中也能看到请求这个补丁的抓包：</p><p><img src="/webpackLearn/assets/img/4-6hot-patch.5e1f20ed.png" alt="图4.5.3 模块热替换模式下的补丁"></p><p>可见补丁中包含了 <code>main.css</code> 文件新编译出来 CSS 代码，网页中的样式也立刻变成了源码中描述的那样。</p><p>但当你修改 <code>main.js</code> 文件时，会发现模块热替换没有生效，而是整个页面被刷新了，为什么修改 <code>main.js</code> 文件时会这样呢？</p><p>Webpack 为了让使用者在使用了模块热替换功能时能[灵活地控制老模块被替换时的逻辑]，可以在源码中定义一些代码去做相应的处理。</p><p>把的 <code>main.js</code> 文件改为如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./AppComponent&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;./main.css&quot;</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>AppComponent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 只有当开启了模块热替换时 `module.hot` 才存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// accept 函数的第一个参数指出当前文件接受哪些子模块的替换，这里表示只接受 `./AppComponent` 这个子模块</span>
  <span class="token comment">// 第2个参数用于在新的子模块加载完毕后需要执行的逻辑</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;./AppComponent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新的 AppComponent 加载成功后重新执行下组建渲染逻辑</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>AppComponent <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中的 <code>module.hot</code> 是当开启模块热替换后注入到 <strong>全局的 API</strong>，用于控制模块热替换的逻辑。</p><p>现在修改 <code>AppComponent.js</code>文件，把 <code>Hello,Webpack</code> 改成 <code>Hello,World</code>，你会发现模块热替换生效了。 但是当你编辑 <code>main.js 时</code>，你会发现整个网页被刷新了。为什么修改这两个文件会有不一样的表现呢？</p><p>当子模块发生更新时，更新事件会一层层往上传递，也就是从 <code>AppComponent.js</code> 文件传递到 <code>main.js</code> 文件， 直到有某层的文件接受了当前变化的模块，也就是 <code>main.js</code> 文件中定义的 <code>module.hot.accept(['./AppComponent'], callback)</code>， 这时就会调用 <code>callback</code> 函数去执行自定义逻辑。<strong>如果事件一直往上抛到最外层都没有文件接受它，就会直接刷新网页</strong>。</p><p>那为什么没有地方接受过 <code>.css</code> 文件，但是修改所有的 <code>.css</code> 文件都会触发模块热替换呢？ 原因在于 <code>style-loader</code> 会注入用于接受 CSS 的代码。</p><blockquote><p>请不要把模块热替换技术用于线上环境，它是专门为提升开发效率生的。</p></blockquote><h2 id="优化模块热替换"><a href="#优化模块热替换" aria-hidden="true" class="header-anchor">#</a> 优化模块热替换</h2><p>在发生模块热替换时，你会在浏览器的控制台中看到类似这样的日志：</p><p><img src="/webpackLearn/assets/img/4-6hmr-log.b28467c5.png" alt="图4.5.4 模块热替换浏览器日志"></p><p>其中的 <code>Updated modules: 68</code>是指 ID 为 <code>68</code> 的模块被替换了，这对开发者来说很不友好，因为开发者不知道 ID 和模块之间的对应关系，最好是把替换了的模块的名称输出出来。 Webpack 内置的 <code>NamedModulesPlugin</code> 插件可以解决该问题，修改 Webpack 配置文件接入该插件：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> NamedModulesPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack/lib/NamedModulesPlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 显示出被替换模块的名称</span>
    <span class="token keyword">new</span> <span class="token class-name">NamedModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>重启构建后你会发现浏览器中的日志更加友好了：</p><p><img src="/webpackLearn/assets/img/4-6hmr-log-named.0bf7acb0.png" alt="图4.5.4 现实出被替换模块的浏览器日志"></p><p>除此之外，模块热替换还面临着和自动刷新一样的性能问题，因为它们都需要监听文件变化和注入客户端。 要优化模块热替换的构建性能，思路和在<a href="/webpackLearn/optimize/optimize-5.html">使用自动刷新中</a>提到的很类似：<strong>监听更少的文件，忽略掉 <code>node_modules</code> 目录下的文件</strong>。</p><p>但是其中提到的关闭默认的 <code>inline</code> 模式手动注入代理客户端的优化方法不能用于在使用模块热替换的情况下， 原因在于模块热替换的运行<strong>依赖</strong>在每个 Chunk 中都包含代理客户端的代码。</p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/webpackLearn/optimize/optimize-5.html" class="prev">
          使用自动刷新
        </a></span><span class="next"><a href="/webpackLearn/optimize/optimize-7.html">
          区分环境
        </a> →
      </span></p></div></div></div></div>
    <script src="/webpackLearn/assets/js/app.77d280ee.js" defer></script><script src="/webpackLearn/assets/js/3.128b6292.js" defer></script>
  </body>
</html>
